Cookbooks contain everything necessary to support configuration for a given “scenario”, but recipes are where this configuration happens. In this lesson, we’ll create our first recipe that will install and configure NGINX.

Documentation:-
Chef cookbook documentation (https://docs.chef.io/cookbooks.html)
Chef recipe documentation (https://docs.chef.io/recipes.html)
Chef resource documentation (https://docs.chef.io/resource.html)
The package resource documentation (https://docs.chef.io/resource_package.html)
The service resource documentation (https://docs.chef.io/resource_service.html)

The default Recipe:-
Every cookbook will come with a default recipe. We can have more than one recipe within a cookbook, but we will always have at least this one. Here’s what the default recipe for our bcf_nginx cookbook contains right now:

~/chef-repo/cookbooks/bcf_nginx/recipes/default.rb

#
# Cookbook:: bcf_nginx
# Recipe:: default
#
# Copyright:: 2018, The Authors, All Rights Reserved.

All Chef code is written in Ruby. We don’t need to be ruby experts to use Chef thankfully, but it does help to understand the syntax, so as we go through this I’ll call out what’s going on in the ruby itself to hopefully provide more clarity.

For these existing lines, we’re seeing ruby comments and none of what we see here is executed.

Installing NGINX:-
Our cookbook is going to install and configure the NGINX package, and one of the benefits of Chef is that we get to “declare” what we want to have the final configuration be and let Chef attempt to make that happen. To achieve this declarative approach, we won’t be writing the individual steps necessary to accomplish things, we’ll instead be leveraging Chef resources. We’ll dig deep into resources in a later lesson, but let’s use the first two right now: package and service:

~/chef-repo/cookbooks/bcf_nginx/recipes/default.rb

package "nginx"

service "nginx" do
  action [:enable, :start]
end

The package resource is in charge of installing the package with the name that we specify. Based on the system that is running the recipe, a different package manager will be used. The package abstracting away the implementation, we don’t have to necessarily worry about whether it is using yum on Red Hat based systems or apt-get on debian based systems.

Similarly, the service package will allow us to run the service without specifying directly if you should use systemd or something else.

These are both “resources”, but when we used service we added the do ... end so that we could modify the default action of the resource. By default, the service resource will only :start the service, so upon reboot, the service won’t start automatically. The do ... end is a ruby “block” and gives us a context to modify the configuration of the resource.

Running the Recipe Locally:-
Eventually, we’ll start utilizing kitchen for automated testing as we develop our cookbook, but for right now we’ll run this locally to see how it works.

To run any recipe, we need to use the chef-client binary. Normally, chef-client interacts with a Chef Server to know what to run, but there are options that we can pass to it to run it locally using [chef_zero][6] (an in-memory Chef Server). Let’s run our recipe to see if it installs NGINX like we expect:

[workstation chef-repo] $ sudo chef-client --local-mode cookbooks/bcf_nginx/recipes/default.rb
...
[2018-04-30T17:59:27+00:00] INFO: Chef Run complete in 8.674367561 seconds

Running handlers:
[2018-04-30T17:59:27+00:00] INFO: Running report handlers
Running handlers complete
[2018-04-30T17:59:27+00:00] INFO: Report handlers complete
Chef Client finished, 3/3 resources updated in 10 seconds
If we manually check the status of the NGINX service using systemctl we should see that it is both running and enabled.

[workstation chef-repo] $ systemctl status nginx
? nginx.service - The nginx HTTP and reverse proxy server
   Loaded: loaded (/usr/lib/systemd/system/nginx.service; enabled; vendor preset: disabled)
   Active: active (running) since Mon 2018-04-30 17:59:27 UTC; 8s ago
  Process: 3546 ExecStart=/usr/sbin/nginx (code=exited, status=0/SUCCESS)
  Process: 3544 ExecStartPre=/usr/sbin/nginx -t (code=exited, status=0/SUCCESS)
  Process: 3542 ExecStartPre=/usr/bin/rm -f /run/nginx.pid (code=exited, status=0/SUCCESS)
 Main PID: 3549 (nginx)
    Tasks: 2
   Memory: 6.6M
   CGroup: /system.slice/nginx.service
           ??3549 nginx: master process /usr/sbin/nginx
           ??3550 nginx: worker process

Apr 30 17:59:27 satyensingh1.mylabserver.com systemd[1]: Starting The nginx HTTP and reverse proxy server...
Apr 30 17:59:27 satyensingh1.mylabserver.com nginx[3544]: nginx: the configuration file /etc/nginx/nginx.conf syntax is ok
Apr 30 17:59:27 satyensingh1.mylabserver.com nginx[3544]: nginx: configuration file /etc/nginx/nginx.conf test is successful
Apr 30 17:59:27 satyensingh1.mylabserver.com systemd[1]: Failed to read PID from file /run/nginx.pid: Invalid argument
Apr 30 17:59:27 satyensingh1.mylabserver.com systemd[1]: Started The nginx HTTP and reverse proxy server.

In just a few lines, we were able to install, start, and enable the NGINX service.


Re-running a Recipe:-
What happens if we run chef-client with this recipe again? Let’s find out.

[workstation chef-repo] $ sudo chef-client --local-mode cookbooks/bcf_nginx/recipes/default.rb
...
Converging 2 resources
Recipe: @recipe_files::/home/user/chef-repo/cookbooks/bcf_nginx/recipes/default.rb
  * yum_package[nginx] action install[2018-04-30T18:23:50+00:00] INFO: Processing yum_package[nginx] action install (@recipe_files::/home/user/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 7)
 (up to date)
  * service[nginx] action enable[2018-04-30T18:23:54+00:00] INFO: Processing service[nginx] action enable (@recipe_files::/home/user/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 9)
 (up to date)
  * service[nginx] action start[2018-04-30T18:23:54+00:00] INFO: Processing service[nginx] action start (@recipe_files::/home/user/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 9)
 (up to date)
[2018-04-30T18:23:54+00:00] INFO: Chef Run complete in 4.279274025 seconds

Running handlers:
[2018-04-30T18:23:54+00:00] INFO: Running report handlers
Running handlers complete
[2018-04-30T18:23:54+00:00] INFO: Report handlers complete
Chef Client finished, 0/3 resources updated in 06 seconds
Because Chef uses a “test and repair” approach, running the same recipe multiple times is idempotent (no changes made after the first time). Let’s manually disable the service before running chef-client one last time.

[workstation chef-repo] $ sudo systemctl disable nginx
[workstation chef-repo] $ sudo chef-client --local-mode cookbooks/bcf_nginx/recipes/default.rb
...
Converging 2 resources
Recipe: @recipe_files::/home/user/chef-repo/cookbooks/bcf_nginx/recipes/default.rb
  * yum_package[nginx] action install[2018-04-30T18:27:46+00:00] INFO: Processing yum_package[nginx] action install (@recipe_files::/home/user/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 7)
 (up to date)
  * service[nginx] action enable[2018-04-30T18:27:50+00:00] INFO: Processing service[nginx] action enable (@recipe_files::/home/user/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 9)
[2018-04-30T18:27:50+00:00] INFO: service[nginx] enabled

    - enable service service[nginx]
  * service[nginx] action start[2018-04-30T18:27:50+00:00] INFO: Processing service[nginx] action start (@recipe_files::/home/user/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 9)
 (up to date)
[2018-04-30T18:27:50+00:00] INFO: Chef Run complete in 4.467122259 seconds

Running handlers:
[2018-04-30T18:27:50+00:00] INFO: Running report handlers
Running handlers complete
[2018-04-30T18:27:50+00:00] INFO: Report handlers complete
Chef Client finished, 1/3 resources updated in 06 seconds


Since the service was not enabled, an action was taken to enable it. This change was the only modification Chef needed to make to get the system back to the desired state.
===================================================================================================================================================================

root@ip-172-31-6-143:/home/ubuntu/chef-repo# cat cookbooks/bcf_nginx/recipes/default.rb
#
# Cookbook:: bcf_nginx
# Recipe:: default
#
# Copyright:: 2019, The Authors, All Rights Reserved.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# vi cookbooks/bcf_nginx/recipes/default.rb
root@ip-172-31-6-143:/home/ubuntu/chef-repo# cat cookbooks/bcf_nginx/recipes/default.rb
#
# Cookbook:: bcf_nginx
# Recipe:: default
#
# Copyright:: 2019, The Authors, All Rights Reserved.
package "nginx"

service "nginx" do
  action [:enable, :start]
end
root@ip-172-31-6-143:/home/ubuntu/chef-repo# sudo chef-client --local-mode cookbooks/bcf_nginx/recipes/default.rb
[2019-12-19T05:47:47+00:00] INFO: Started Chef Infra Zero at chefzero://localhost:1 with repository at /home/ubuntu/chef-repo
  One version per cookbook

Starting Chef Infra Client, version 15.5.17
[2019-12-19T05:47:47+00:00] INFO: *** Chef Infra Client 15.5.17 ***
[2019-12-19T05:47:47+00:00] INFO: Platform: x86_64-linux
[2019-12-19T05:47:47+00:00] INFO: Chef-client pid: 21569
[2019-12-19T05:47:50+00:00] INFO: Run List is []
[2019-12-19T05:47:50+00:00] INFO: Run List expands to []
[2019-12-19T05:47:50+00:00] INFO: Starting Chef Infra Client Run for rgurnule
[2019-12-19T05:47:50+00:00] INFO: Running start handlers
[2019-12-19T05:47:50+00:00] INFO: Start handlers complete.
resolving cookbooks for run list: []
[2019-12-19T05:47:50+00:00] INFO: Loading cookbooks []
Synchronizing Cookbooks:
Installing Cookbook Gems:
Compiling Cookbooks...
[2019-12-19T05:47:50+00:00] WARN: Node rgurnule has an empty run list.
Converging 2 resources
Recipe: @recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb
  * apt_package[nginx] action install[2019-12-19T05:47:50+00:00] INFO: Processing apt_package[nginx] action install (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 6)
[2019-12-19T05:47:59+00:00] INFO: apt_package[nginx] installed nginx at 1.14.0-0ubuntu1.6

    - install version 1.14.0-0ubuntu1.6 of package nginx
  * service[nginx] action enable[2019-12-19T05:47:59+00:00] INFO: Processing service[nginx] action enable (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 8)
 (up to date)
  * service[nginx] action start[2019-12-19T05:47:59+00:00] INFO: Processing service[nginx] action start (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 8)


    ================================================================================
    Error executing action `start` on resource 'service[nginx]'
    ================================================================================

    Mixlib::ShellOut::ShellCommandFailed
    ------------------------------------
    Expected process to exit with [0], but received '1'
    ---- Begin output of /bin/systemctl --system start nginx ----
    STDOUT:
    STDERR: Job for nginx.service failed because the control process exited with error code.
    See "systemctl status nginx.service" and "journalctl -xe" for details.
    ---- End output of /bin/systemctl --system start nginx ----
    Ran /bin/systemctl --system start nginx returned 1

    Resource Declaration:
    ---------------------
    # In /home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb

      8: service "nginx" do
      9:   action [:enable, :start]
     10: end

    Compiled Resource:
    ------------------
    # Declared in /home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb:8:in `from_file'

    service("nginx") do
      action [:enable, :start]
      default_guard_interpreter :default
      declared_type :service
      cookbook_name "@recipe_files"
      recipe_name "/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb"
      service_name "nginx"
      running false
      enabled true
      masked false
    end

    System Info:
    ------------
    chef_version=15.5.17
    platform=ubuntu
    platform_version=18.04
    ruby=ruby 2.6.5p114 (2019-10-01 revision 67812) [x86_64-linux]
    program_name=/usr/bin/chef-client
    executable=/opt/chefdk/bin/chef-client

[2019-12-19T05:48:02+00:00] INFO: Running queued delayed notifications before re-raising exception

Running handlers:
[2019-12-19T05:48:02+00:00] ERROR: Running exception handlers
Running handlers complete
[2019-12-19T05:48:02+00:00] ERROR: Exception handlers complete
Chef Infra Client failed. 1 resources updated in 14 seconds
[2019-12-19T05:48:02+00:00] FATAL: Stacktrace dumped to /home/ubuntu/chef-repo/.chef/local-mode-cache/cache/chef-stacktrace.out
[2019-12-19T05:48:02+00:00] FATAL: Please provide the contents of the stacktrace.out file if you file a bug report
[2019-12-19T05:48:02+00:00] FATAL: Mixlib::ShellOut::ShellCommandFailed: service[nginx] (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 8) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '1'
---- Begin output of /bin/systemctl --system start nginx ----
STDOUT:
STDERR: Job for nginx.service failed because the control process exited with error code.
See "systemctl status nginx.service" and "journalctl -xe" for details.
---- End output of /bin/systemctl --system start nginx ----
Ran /bin/systemctl --system start nginx returned 1
root@ip-172-31-6-143:/home/ubuntu/chef-repo# vi cookbooks/bcf_nginx/recipes/default.rb
root@ip-172-31-6-143:/home/ubuntu/chef-repo# vi cookbooks/bcf_nginx/recipes/default.rb
root@ip-172-31-6-143:/home/ubuntu/chef-repo# sudo chef-client --local-mode cookbooks/bcf_nginx/recipes/default.rb
[2019-12-19T05:49:33+00:00] INFO: Started Chef Infra Zero at chefzero://localhost:1 with repository at /home/ubuntu/chef-repo
  One version per cookbook

Starting Chef Infra Client, version 15.5.17
[2019-12-19T05:49:33+00:00] INFO: *** Chef Infra Client 15.5.17 ***
[2019-12-19T05:49:33+00:00] INFO: Platform: x86_64-linux
[2019-12-19T05:49:33+00:00] INFO: Chef-client pid: 22570
[2019-12-19T05:49:35+00:00] INFO: Run List is []
[2019-12-19T05:49:35+00:00] INFO: Run List expands to []
[2019-12-19T05:49:35+00:00] INFO: Starting Chef Infra Client Run for rgurnule
[2019-12-19T05:49:35+00:00] INFO: Running start handlers
[2019-12-19T05:49:35+00:00] INFO: Start handlers complete.
resolving cookbooks for run list: []
[2019-12-19T05:49:35+00:00] INFO: Loading cookbooks []
Synchronizing Cookbooks:
Installing Cookbook Gems:
Compiling Cookbooks...
[2019-12-19T05:49:35+00:00] WARN: Node rgurnule has an empty run list.
Converging 0 resources
[2019-12-19T05:49:35+00:00] INFO: Chef Infra Client Run complete in 0.165318147 seconds

Running handlers:
[2019-12-19T05:49:35+00:00] INFO: Running report handlers
Running handlers complete
[2019-12-19T05:49:35+00:00] INFO: Report handlers complete
Chef Infra Client finished, 0/0 resources updated in 02 seconds
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl status nginx.service
? nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2019-12-19 05:48:02 UTC; 6min ago
     Docs: man:nginx(8)
  Process: 22225 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=1/FAILURE)
  Process: 22215 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)

Dec 19 05:47:59 ip-172-31-6-143 systemd[1]: Starting A high performance web server and a reverse proxy server...
Dec 19 05:47:59 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:00 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:00 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:01 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:01 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:02 ip-172-31-6-143 nginx[22225]: nginx: [emerg] still could not bind()
Dec 19 05:48:02 ip-172-31-6-143 systemd[1]: nginx.service: Control process exited, code=exited status=1
Dec 19 05:48:02 ip-172-31-6-143 systemd[1]: nginx.service: Failed with result 'exit-code'.
Dec 19 05:48:02 ip-172-31-6-143 systemd[1]: Failed to start A high performance web server and a reverse proxy server.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# ps -eaf|grep nginx
root      1059   940  0 05:24 ?        00:00:00 runsv nginx
opscode   1294  1059  0 05:24 ?        00:00:00 svlogd -tt /var/log/opscode/nginx
root      1370  1059  0 05:24 ?        00:00:00 nginx: master process /opt/opscode/embedded/sbin/nginx -c /var/opt/opscode/nginx/etc/nginx.conf
opscode   2550  1370  0 05:24 ?        00:00:00 nginx: worker process
opscode   2551  1370  0 05:24 ?        00:00:00 nginx: worker process
opscode   2552  1370  0 05:24 ?        00:00:00 nginx: cache manager process
root     23973  4187  0 05:56 pts/0    00:00:00 grep nginx
root@ip-172-31-6-143:/home/ubuntu/chef-repo# vi /var/opt/opscode/nginx/etc/nginx.conf
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl status nginx.service
? nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2019-12-19 05:48:02 UTC; 9min ago
     Docs: man:nginx(8)
  Process: 22225 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=1/FAILURE)
  Process: 22215 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)

Dec 19 05:47:59 ip-172-31-6-143 systemd[1]: Starting A high performance web server and a reverse proxy server...
Dec 19 05:47:59 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:00 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:00 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:01 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:01 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:02 ip-172-31-6-143 nginx[22225]: nginx: [emerg] still could not bind()
Dec 19 05:48:02 ip-172-31-6-143 systemd[1]: nginx.service: Control process exited, code=exited status=1
Dec 19 05:48:02 ip-172-31-6-143 systemd[1]: nginx.service: Failed with result 'exit-code'.
Dec 19 05:48:02 ip-172-31-6-143 systemd[1]: Failed to start A high performance web server and a reverse proxy server.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# sudo chef-client --local-mode cookbooks/bcf_nginx/recipes/default.rb
[2019-12-19T05:57:23+00:00] INFO: Started Chef Infra Zero at chefzero://localhost:1 with repository at /home/ubuntu/chef-repo
  One version per cookbook

Starting Chef Infra Client, version 15.5.17
[2019-12-19T05:57:23+00:00] INFO: *** Chef Infra Client 15.5.17 ***
[2019-12-19T05:57:23+00:00] INFO: Platform: x86_64-linux
[2019-12-19T05:57:23+00:00] INFO: Chef-client pid: 24207
[2019-12-19T05:57:25+00:00] INFO: Run List is []
[2019-12-19T05:57:25+00:00] INFO: Run List expands to []
[2019-12-19T05:57:25+00:00] INFO: Starting Chef Infra Client Run for rgurnule
[2019-12-19T05:57:25+00:00] INFO: Running start handlers
[2019-12-19T05:57:25+00:00] INFO: Start handlers complete.
resolving cookbooks for run list: []
[2019-12-19T05:57:25+00:00] INFO: Loading cookbooks []
Synchronizing Cookbooks:
Installing Cookbook Gems:
Compiling Cookbooks...
[2019-12-19T05:57:25+00:00] WARN: Node rgurnule has an empty run list.
Converging 0 resources
[2019-12-19T05:57:25+00:00] INFO: Chef Infra Client Run complete in 0.07814559 seconds

Running handlers:
[2019-12-19T05:57:25+00:00] INFO: Running report handlers
Running handlers complete
[2019-12-19T05:57:25+00:00] INFO: Report handlers complete
Chef Infra Client finished, 0/0 resources updated in 01 seconds
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl status nginx.service
? nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2019-12-19 05:48:02 UTC; 9min ago
     Docs: man:nginx(8)
  Process: 22225 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=1/FAILURE)
  Process: 22215 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)

Dec 19 05:47:59 ip-172-31-6-143 systemd[1]: Starting A high performance web server and a reverse proxy server...
Dec 19 05:47:59 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:00 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:00 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:01 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:01 ip-172-31-6-143 nginx[22225]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:48:02 ip-172-31-6-143 nginx[22225]: nginx: [emerg] still could not bind()
Dec 19 05:48:02 ip-172-31-6-143 systemd[1]: nginx.service: Control process exited, code=exited status=1
Dec 19 05:48:02 ip-172-31-6-143 systemd[1]: nginx.service: Failed with result 'exit-code'.
Dec 19 05:48:02 ip-172-31-6-143 systemd[1]: Failed to start A high performance web server and a reverse proxy server.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# vi cookbooks/bcf_nginx/recipes/default.rb
root@ip-172-31-6-143:/home/ubuntu/chef-repo# sudo chef-client --local-mode cookbooks/bcf_nginx/recipes/default.rb
[2019-12-19T05:58:18+00:00] INFO: Started Chef Infra Zero at chefzero://localhost:1 with repository at /home/ubuntu/chef-repo
  One version per cookbook

Starting Chef Infra Client, version 15.5.17
[2019-12-19T05:58:18+00:00] INFO: *** Chef Infra Client 15.5.17 ***
[2019-12-19T05:58:18+00:00] INFO: Platform: x86_64-linux
[2019-12-19T05:58:18+00:00] INFO: Chef-client pid: 24533
[2019-12-19T05:58:20+00:00] INFO: Run List is []
[2019-12-19T05:58:20+00:00] INFO: Run List expands to []
[2019-12-19T05:58:20+00:00] INFO: Starting Chef Infra Client Run for rgurnule
[2019-12-19T05:58:20+00:00] INFO: Running start handlers
[2019-12-19T05:58:20+00:00] INFO: Start handlers complete.
resolving cookbooks for run list: []
[2019-12-19T05:58:20+00:00] INFO: Loading cookbooks []
Synchronizing Cookbooks:
Installing Cookbook Gems:
Compiling Cookbooks...
[2019-12-19T05:58:20+00:00] WARN: Node rgurnule has an empty run list.
Converging 2 resources
Recipe: @recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb
  * apt_package[nginx] action install[2019-12-19T05:58:20+00:00] INFO: Processing apt_package[nginx] action install (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 6)
 (up to date)
  * service[nginx] action enable[2019-12-19T05:58:20+00:00] INFO: Processing service[nginx] action enable (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 8)
 (up to date)
  * service[nginx] action start[2019-12-19T05:58:20+00:00] INFO: Processing service[nginx] action start (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 8)


    ================================================================================
    Error executing action `start` on resource 'service[nginx]'
    ================================================================================

    Mixlib::ShellOut::ShellCommandFailed
    ------------------------------------
    Expected process to exit with [0], but received '1'
    ---- Begin output of /bin/systemctl --system start nginx ----
    STDOUT:
    STDERR: Job for nginx.service failed because the control process exited with error code.
    See "systemctl status nginx.service" and "journalctl -xe" for details.
    ---- End output of /bin/systemctl --system start nginx ----
    Ran /bin/systemctl --system start nginx returned 1

    Resource Declaration:
    ---------------------
    # In /home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb

      8: service "nginx" do
      9:   action [:enable, :start]
     10: end

    Compiled Resource:
    ------------------
    # Declared in /home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb:8:in `from_file'

    service("nginx") do
      action [:enable, :start]
      default_guard_interpreter :default
      declared_type :service
      cookbook_name "@recipe_files"
      recipe_name "/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb"
      service_name "nginx"
      running false
      enabled true
      masked false
    end

    System Info:
    ------------
    chef_version=15.5.17
    platform=ubuntu
    platform_version=18.04
    ruby=ruby 2.6.5p114 (2019-10-01 revision 67812) [x86_64-linux]
    program_name=/usr/bin/chef-client
    executable=/opt/chefdk/bin/chef-client

[2019-12-19T05:58:23+00:00] INFO: Running queued delayed notifications before re-raising exception

Running handlers:
[2019-12-19T05:58:23+00:00] ERROR: Running exception handlers
Running handlers complete
[2019-12-19T05:58:23+00:00] ERROR: Exception handlers complete
Chef Infra Client failed. 0 resources updated in 04 seconds
[2019-12-19T05:58:23+00:00] FATAL: Stacktrace dumped to /home/ubuntu/chef-repo/.chef/local-mode-cache/cache/chef-stacktrace.out
[2019-12-19T05:58:23+00:00] FATAL: Please provide the contents of the stacktrace.out file if you file a bug report
[2019-12-19T05:58:23+00:00] FATAL: Mixlib::ShellOut::ShellCommandFailed: service[nginx] (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 8) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '1'
---- Begin output of /bin/systemctl --system start nginx ----
STDOUT:
STDERR: Job for nginx.service failed because the control process exited with error code.
See "systemctl status nginx.service" and "journalctl -xe" for details.
---- End output of /bin/systemctl --system start nginx ----
Ran /bin/systemctl --system start nginx returned 1
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl status nginx.service
? nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2019-12-19 05:58:23 UTC; 45s ago
     Docs: man:nginx(8)
  Process: 24688 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=1/FAILURE)
  Process: 24681 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)

Dec 19 05:58:20 ip-172-31-6-143 systemd[1]: Starting A high performance web server and a reverse proxy server...
Dec 19 05:58:20 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:23 ip-172-31-6-143 nginx[24688]: nginx: [emerg] still could not bind()
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Control process exited, code=exited status=1
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Failed with result 'exit-code'.
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: Failed to start A high performance web server and a reverse proxy server.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# ps -eaf|grep nginx
root      1059   940  0 05:24 ?        00:00:00 runsv nginx
opscode   1294  1059  0 05:24 ?        00:00:00 svlogd -tt /var/log/opscode/nginx
root      1370  1059  0 05:24 ?        00:00:00 nginx: master process /opt/opscode/embedded/sbin/nginx -c /var/opt/opscode/nginx/etc/nginx.conf
opscode   2550  1370  0 05:24 ?        00:00:00 nginx: worker process
opscode   2551  1370  0 05:24 ?        00:00:00 nginx: worker process
opscode   2552  1370  0 05:24 ?        00:00:00 nginx: cache manager process
root     24893  4187  0 05:59 pts/0    00:00:00 grep nginx
root@ip-172-31-6-143:/home/ubuntu/chef-repo# kill -9 1370
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl status nginx.service
? nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2019-12-19 05:58:23 UTC; 1min 5s ago
     Docs: man:nginx(8)
  Process: 24688 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=1/FAILURE)
  Process: 24681 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)

Dec 19 05:58:20 ip-172-31-6-143 systemd[1]: Starting A high performance web server and a reverse proxy server...
Dec 19 05:58:20 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:23 ip-172-31-6-143 nginx[24688]: nginx: [emerg] still could not bind()
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Control process exited, code=exited status=1
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Failed with result 'exit-code'.
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: Failed to start A high performance web server and a reverse proxy server.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl stops nginx.service
Unknown operation stops.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl stop nginx.service
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl status nginx.service
? nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2019-12-19 05:58:23 UTC; 1min 29s ago
     Docs: man:nginx(8)
  Process: 24688 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=1/FAILURE)
  Process: 24681 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)

Dec 19 05:58:20 ip-172-31-6-143 systemd[1]: Starting A high performance web server and a reverse proxy server...
Dec 19 05:58:20 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:23 ip-172-31-6-143 nginx[24688]: nginx: [emerg] still could not bind()
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Control process exited, code=exited status=1
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Failed with result 'exit-code'.
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: Failed to start A high performance web server and a reverse proxy server.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl status nginx
? nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2019-12-19 05:58:23 UTC; 2min 33s ago
     Docs: man:nginx(8)
  Process: 24688 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=1/FAILURE)
  Process: 24681 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)

Dec 19 05:58:20 ip-172-31-6-143 systemd[1]: Starting A high performance web server and a reverse proxy server...
Dec 19 05:58:20 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:23 ip-172-31-6-143 nginx[24688]: nginx: [emerg] still could not bind()
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Control process exited, code=exited status=1
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Failed with result 'exit-code'.
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: Failed to start A high performance web server and a reverse proxy server.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# sudo systemctl disable nginx
Synchronizing state of nginx.service with SysV service script with /lib/systemd/systemd-sysv-install.
Executing: /lib/systemd/systemd-sysv-install disable nginx
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl status nginx
? nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; disabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2019-12-19 05:58:23 UTC; 3min 17s ago
     Docs: man:nginx(8)

Dec 19 05:58:20 ip-172-31-6-143 systemd[1]: Starting A high performance web server and a reverse proxy server...
Dec 19 05:58:20 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:21 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:22 ip-172-31-6-143 nginx[24688]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 05:58:23 ip-172-31-6-143 nginx[24688]: nginx: [emerg] still could not bind()
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Control process exited, code=exited status=1
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: nginx.service: Failed with result 'exit-code'.
Dec 19 05:58:23 ip-172-31-6-143 systemd[1]: Failed to start A high performance web server and a reverse proxy server.
root@ip-172-31-6-143:/home/ubuntu/chef-repo# sudo chef-client --local-mode cookbooks/bcf_nginx/recipes/default.rb
[2019-12-19T06:02:08+00:00] INFO: Started Chef Infra Zero at chefzero://localhost:1 with repository at /home/ubuntu/chef-repo
  One version per cookbook

Starting Chef Infra Client, version 15.5.17
[2019-12-19T06:02:08+00:00] INFO: *** Chef Infra Client 15.5.17 ***
[2019-12-19T06:02:08+00:00] INFO: Platform: x86_64-linux
[2019-12-19T06:02:08+00:00] INFO: Chef-client pid: 25859
[2019-12-19T06:02:10+00:00] INFO: Run List is []
[2019-12-19T06:02:10+00:00] INFO: Run List expands to []
[2019-12-19T06:02:10+00:00] INFO: Starting Chef Infra Client Run for rgurnule
[2019-12-19T06:02:10+00:00] INFO: Running start handlers
[2019-12-19T06:02:10+00:00] INFO: Start handlers complete.
resolving cookbooks for run list: []
[2019-12-19T06:02:10+00:00] INFO: Loading cookbooks []
Synchronizing Cookbooks:
Installing Cookbook Gems:
Compiling Cookbooks...
[2019-12-19T06:02:10+00:00] WARN: Node rgurnule has an empty run list.
Converging 2 resources
Recipe: @recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb
  * apt_package[nginx] action install[2019-12-19T06:02:10+00:00] INFO: Processing apt_package[nginx] action install (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 6)
 (up to date)
  * service[nginx] action enable[2019-12-19T06:02:10+00:00] INFO: Processing service[nginx] action enable (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 8)
[2019-12-19T06:02:11+00:00] INFO: service[nginx] enabled

    - enable service service[nginx]
  * service[nginx] action start[2019-12-19T06:02:11+00:00] INFO: Processing service[nginx] action start (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 8)


    ================================================================================
    Error executing action `start` on resource 'service[nginx]'
    ================================================================================

    Mixlib::ShellOut::ShellCommandFailed
    ------------------------------------
    Expected process to exit with [0], but received '1'
    ---- Begin output of /bin/systemctl --system start nginx ----
    STDOUT:
    STDERR: Job for nginx.service failed because the control process exited with error code.
    See "systemctl status nginx.service" and "journalctl -xe" for details.
    ---- End output of /bin/systemctl --system start nginx ----
    Ran /bin/systemctl --system start nginx returned 1

    Resource Declaration:
    ---------------------
    # In /home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb

      8: service "nginx" do
      9:   action [:enable, :start]
     10: end

    Compiled Resource:
    ------------------
    # Declared in /home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb:8:in `from_file'

    service("nginx") do
      action [:enable, :start]
      updated true
      default_guard_interpreter :default
      declared_type :service
      cookbook_name "@recipe_files"
      recipe_name "/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb"
      service_name "nginx"
      running false
      enabled true
      masked false
    end

    System Info:
    ------------
    chef_version=15.5.17
    platform=ubuntu
    platform_version=18.04
    ruby=ruby 2.6.5p114 (2019-10-01 revision 67812) [x86_64-linux]
    program_name=/usr/bin/chef-client
    executable=/opt/chefdk/bin/chef-client

[2019-12-19T06:02:13+00:00] INFO: Running queued delayed notifications before re-raising exception

Running handlers:
[2019-12-19T06:02:13+00:00] ERROR: Running exception handlers
Running handlers complete
[2019-12-19T06:02:13+00:00] ERROR: Exception handlers complete
Chef Infra Client failed. 1 resources updated in 05 seconds
[2019-12-19T06:02:13+00:00] FATAL: Stacktrace dumped to /home/ubuntu/chef-repo/.chef/local-mode-cache/cache/chef-stacktrace.out
[2019-12-19T06:02:13+00:00] FATAL: Please provide the contents of the stacktrace.out file if you file a bug report
[2019-12-19T06:02:13+00:00] FATAL: Mixlib::ShellOut::ShellCommandFailed: service[nginx] (@recipe_files::/home/ubuntu/chef-repo/cookbooks/bcf_nginx/recipes/default.rb line 8) had an error: Mixlib::ShellOut::ShellCommandFailed: Expected process to exit with [0], but received '1'
---- Begin output of /bin/systemctl --system start nginx ----
STDOUT:
STDERR: Job for nginx.service failed because the control process exited with error code.
See "systemctl status nginx.service" and "journalctl -xe" for details.
---- End output of /bin/systemctl --system start nginx ----
Ran /bin/systemctl --system start nginx returned 1
root@ip-172-31-6-143:/home/ubuntu/chef-repo# systemctl status nginx
? nginx.service - A high performance web server and a reverse proxy server
   Loaded: loaded (/lib/systemd/system/nginx.service; enabled; vendor preset: enabled)
   Active: failed (Result: exit-code) since Thu 2019-12-19 06:02:13 UTC; 8s ago
     Docs: man:nginx(8)
  Process: 26106 ExecStart=/usr/sbin/nginx -g daemon on; master_process on; (code=exited, status=1/FAILURE)
  Process: 26094 ExecStartPre=/usr/sbin/nginx -t -q -g daemon on; master_process on; (code=exited, status=0/SUCCESS)

Dec 19 06:02:11 ip-172-31-6-143 systemd[1]: Starting A high performance web server and a reverse proxy server...
Dec 19 06:02:11 ip-172-31-6-143 nginx[26106]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 06:02:11 ip-172-31-6-143 nginx[26106]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 06:02:12 ip-172-31-6-143 nginx[26106]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 06:02:12 ip-172-31-6-143 nginx[26106]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 06:02:13 ip-172-31-6-143 nginx[26106]: nginx: [emerg] bind() to 0.0.0.0:80 failed (98: Address already in use)
Dec 19 06:02:13 ip-172-31-6-143 nginx[26106]: nginx: [emerg] still could not bind()
Dec 19 06:02:13 ip-172-31-6-143 systemd[1]: nginx.service: Control process exited, code=exited status=1
Dec 19 06:02:13 ip-172-31-6-143 systemd[1]: nginx.service: Failed with result 'exit-code'.
Dec 19 06:02:13 ip-172-31-6-143 systemd[1]: Failed to start A high performance web server and a reverse proxy server.
root@ip-172-31-6-143:/home/ubuntu/chef-repo#


